from telethon import TelegramClient, events
import asyncio
import time
import random
import datetime

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ
api_id = 27404031
api_hash = '82e969739914ccf489e11db575be4d46'

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø³Ù…ÙŠ (Ù…Ù† BotFather)
bot_token = '7114378456:AAEptlcJpGG80v_xGHUTXC11i3PpfEyzQ00'

# Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù†ÙØµÙ„ÙŠÙ†
user_client = TelegramClient('user_session', api_id, api_hash)
bot_client = TelegramClient('bot_session', api_id, api_hash)

# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
replied_users = {}
spam_users = {}
total_replies = 0
paused = False
user_message_counts = {}
REPLY_COOLDOWN = 300  # ÙØªØ±Ø© Ø§Ù„ÙƒÙˆÙ„ Ø¯Ø§ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø«ÙˆØ§Ù†ÙŠ)

# Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª (Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
excluded_users = {6315517112, 6630823325}  # Ø£Ø¶Ù Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ØªÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø§Ø³ØªØ«Ù†Ø§Ø¦Ù‡Ø§

main_replies = [
    "Ø§Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ Ø¹Ø²ÙŠØ²ÙŠ {name}ØŒ Ø§Ø¨Ùˆ ÙŠØ²Ù† Ø­Ø§Ù„ÙŠØ§ ØºÙŠØ± Ù…ØªÙˆÙØ± ÙˆØ§Ù†Ø§ Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ğŸ‘¾ğŸ¤–",
    "Ù…Ø±Ø­Ø¨Ø§ {name}ØŒ Ø§Ø¨Ùˆ ÙŠØ²Ù† Ù…Ø´ØºÙˆÙ„ Ø­Ø§Ù„ÙŠØ§ØŒ Ø³Ø£Ø¨Ù„ØºÙ‡ Ø¨Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ø§Ø­Ù‚Ø§!",
    "ÙŠØ§ Ù‡Ù„Ø§ {name}ØŒ Ø§Ø¨Ùˆ ÙŠØ²Ù† Ø­Ø§Ù„ÙŠØ§ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù†Ø§ Ø¨ÙˆØª Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¢Ù„ÙŠ!",
]

warning_reply = "Ù„Ø§ ØªÙ„Ø­ Ù‡Ø³Ù‡ ÙŠØ¬ÙŠ Ø§Ø¨Ùˆ ÙŠØ²Ù† ÙˆÙŠØ±Ø¯ Ø¹Ù„ÙŠÙƒ {name}."

def log_message(message):
    with open("log.txt", "a", encoding="utf-8") as file:
        file.write(f"{message}\n")

@user_client.on(events.NewMessage)
async def auto_reply(event):
    global total_replies, paused

    if not event.is_private or paused:
        return

    sender = await event.get_sender()
    name = sender.first_name or "ØµØ¯ÙŠÙ‚ÙŠ"
    now = time.time()
    last_reply_time = replied_users.get(sender.id, 0)

    # Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ø³Ø¨Ø§Ù…
    if sender.id in spam_users and now - spam_users[sender.id] < 3600:
        return  # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø³Ø¨Ø§Ù…Ø±

    # Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
    if sender.id in excluded_users:
        return  # ØªØ¬Ø§Ù‡Ù„ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙƒÙˆÙ„ Ø¯Ø§ÙˆÙ† Ù„Ù„Ù…Ø³ØªØ«Ù†ÙŠÙ†

    # ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    user_message_counts.setdefault(sender.id, [])
    user_message_counts[sender.id].append(now)

    # Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©)
    user_message_counts[sender.id] = [
        msg_time for msg_time in user_message_counts[sender.id]
        if now - msg_time <= 60
    ]

    # Ø¥Ø°Ø§ Ø¯Ø§Ø² Ø£ÙƒØ«Ø± Ù…Ù† 10 Ø±Ø³Ø§Ø¦Ù„ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø© â” Ù†ÙˆÙ‚ÙÙ‡
    if len(user_message_counts[sender.id]) >= 200:
        spam_users[sender.id] = now
        log_message(f"[{time.ctime(now)}] Ø³Ø¨Ø§Ù…: {sender.id} ØªÙ… Ø­Ø¸Ø±Ù‡ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø³Ø§Ø¹Ø©.")
        print(f"Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø¨Ø§Ù…Ø± {sender.id} ØªÙ… ØªÙˆÙ‚ÙŠÙÙ‡ Ù…Ø¤Ù‚ØªØ§Ù‹.")
        return

    # Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    if now - last_reply_time >= REPLY_COOLDOWN:
        reply = random.choice(main_replies).format(name=name)
        await event.respond(reply)
        replied_users[sender.id] = now
        total_replies += 1
        log_message(f"[{time.ctime(now)}] Ø±Ø¯ Ø£Ø³Ø§Ø³ÙŠ Ø¥Ù„Ù‰ {name} ({sender.id}): {reply}")
        print(f"Ø±Ø¯ Ø¹Ù„Ù‰ {sender.id} | Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯: {total_replies}")

    # ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ Ø¯Ø§Ø² Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø±Ø³Ø§Ø¦Ù„ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø©
    elif len(user_message_counts[sender.id]) == 3:
        await event.respond(warning_reply.format(name=name))
        log_message(f"[{time.ctime(now)}] ØªØ­Ø°ÙŠØ±: {name} ({sender.id}) Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø§Ø­Ù‡.")

@bot_client.on(events.NewMessage(pattern='/start'))
async def handle_start(event):
    global paused
    paused = False
    await event.respond("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©.")
    log_message(f"[{time.ctime()}] Ø§Ø³ØªÙ„Ù… Ø£Ù…Ø± /start.")
    print("ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¨ÙˆØª!")

@bot_client.on(events.NewMessage(pattern='/stop'))
async def handle_stop(event):
    global paused
    paused = True
    await event.respond("â›” ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹.")
    log_message(f"[{time.ctime()}] Ø§Ø³ØªÙ„Ù… Ø£Ù…Ø± /stop.")
    print("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¨ÙˆØª!")

@bot_client.on(events.NewMessage(pattern='/status'))
async def handle_status(event):
    status_text = "âœ… Ø´ØºØ§Ù„" if not paused else "â›” Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§"
    await event.respond(f"Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª: {status_text}\nØ¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙƒÙ„ÙŠØ©: {total_replies}")
    log_message(f"[{time.ctime()}] Ø§Ø³ØªÙ„Ù… Ø£Ù…Ø± /status.")
    print("ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©.")

@bot_client.on(events.NewMessage(pattern='/reset'))
async def handle_reset(event):
    global replied_users, spam_users, total_replies, user_message_counts
    replied_users = {}
    spam_users = {}
    user_message_counts = {}
    total_replies = 0
    await event.respond("â™»ï¸ ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")
    log_message(f"[{time.ctime()}] Ø§Ø³ØªÙ„Ù… Ø£Ù…Ø± /reset ÙˆØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª.")
    print("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª.")

@bot_client.on(events.NewMessage(pattern='/setcooldown'))
async def handle_setcooldown(event):
    cmd_parts = event.raw_text.split(' ')
    if len(cmd_parts) != 2 or not cmd_parts[1].isdigit():
        await event.respond("âŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµØ­ÙŠØ­: /setcooldown <Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ>\n"
                            "ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† 1 Ùˆ 3600 Ø«Ø§Ù†ÙŠØ©.")
        return
    
    cooldown = int(cmd_parts[1])
    if cooldown < 1 or cooldown > 3600:
        await event.respond("âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† 1 Ùˆ 3600 Ø«Ø§Ù†ÙŠØ©.")
        return
    
    global REPLY_COOLDOWN
    REPLY_COOLDOWN = cooldown
    await event.respond(f"â³ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙˆÙ„ Ø¯Ø§ÙˆÙ† Ø§Ù„Ù‰ {cooldown} Ø«Ø§Ù†ÙŠØ©.")
    log_message(f"[{time.ctime()}] ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙˆÙ„ Ø¯Ø§ÙˆÙ† Ø§Ù„Ù‰ {cooldown} Ø«Ø§Ù†ÙŠØ©.")
    print(f"ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙˆÙ„ Ø¯Ø§ÙˆÙ† Ø§Ù„Ù‰ {cooldown} Ø«Ø§Ù†ÙŠØ©.")

@bot_client.on(events.NewMessage(pattern='/help'))
async def handle_help(event):
    help_text = (
        "ğŸ’¡ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª:\n"
        "- `/start` - Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©.\n"
        "- `/stop` - Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¤Ù‚ØªÙ‹Ø§.\n"
        "- `/status` - Ù„Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª ÙˆØ¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙƒÙ„ÙŠØ©.\n"
        "- `/reset` - Ù„ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n"
        "- `/setcooldown <Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ>` - Ù„ØªØºÙŠÙŠØ± ÙØªØ±Ø© Ø§Ù„ÙƒÙˆÙ„ Ø¯Ø§ÙˆÙ†.\n"
        "ØªØ¬Ù†Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ ÙˆÙ‚Øª Ù‚ØµÙŠØ± Ø­ØªÙ‰ Ù„Ø§ ØªÙØ¹ØªØ¨Ø± Ø³Ø¨Ø§Ù…."
    )
    await event.respond(help_text)
    log_message(f"[{time.ctime()}] Ø§Ø³ØªÙ„Ù… Ø£Ù…Ø± /help.")
    print("ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©.")

async def auto_reset():
    while True:
        now = datetime.datetime.now()
        next_reset = now.replace(hour=0, minute=0, second=0, microsecond=0) + datetime.timedelta(days=1)
        wait_seconds = (next_reset - now).total_seconds()
        await asyncio.sleep(wait_seconds)
        
        global replied_users, spam_users, total_replies, user_message_counts
        replied_users = {}
        spam_users = {}
        user_message_counts = {}
        total_replies = 0
        log_message(f"[{time.ctime()}] ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ.")
        print("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù„ÙŠÙ„.")

async def main():
    retries = 10
    for attempt in range(1, retries + 1):
        try:
            await user_client.start()
            print("âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ø´ØªØºÙ„.")
            break
        except Exception as e:
            print(f"âŒ Ù…Ø­Ø§ÙˆÙ„Ø© {attempt} ÙØ´Ù„Øª: {e}")
            if attempt == retries:
                print("âŒ ÙØ´Ù„ Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ.")
                return
            await asyncio.sleep(5)

    try:
        await bot_client.start(bot_token=bot_token)
        print("âœ… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø³Ù…ÙŠ Ø§Ø´ØªØºÙ„.")
    except Exception as e:
        print(f"âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø³Ù…ÙŠ: {e}")
        return

    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ø¹ Ø¨Ø¹Ø¶
    await asyncio.gather(
        user_client.run_until_disconnected(),
        bot_client.run_until_disconnected(),
        auto_reset()
    )
